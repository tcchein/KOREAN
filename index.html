<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>éŸ“æ–‡å–®å­—ç·´ç¿’å°å·¥å…·ï¼ˆé›²ç«¯åŒæ­¥ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      line-height: 1.5;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 16px 20px 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      border-radius: 8px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin-top: 24px;
    }
    .section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      margin-top: 12px;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      background: #1976d2;
      color: #fff;
    }
    button.secondary {
      background: #999;
      margin-left: 8px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .today-list {
      margin-top: 8px;
      font-size: 14px;
      background: #fafafa;
      border-radius: 4px;
      padding: 8px;
      max-height: 160px;
      overflow-y: auto;
    }
    .today-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .today-item span {
      flex: 1;
      margin-right: 8px;
    }
    .today-item button {
      flex-shrink: 0;
      padding: 4px 8px;
      font-size: 12px;
    }
    #quizArea {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      background: #fafafa;
      display: none;
    }
    #questionText {
      font-size: 18px;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 6px;
    }
    #quizInfo {
      font-size: 14px;
      color: #555;
    }
    #feedback {
      margin-top: 8px;
      font-size: 14px;
      min-height: 18px;
    }
    #summary {
      margin-top: 12px;
      font-size: 14px;
    }
    ul {
      padding-left: 20px;
    }
    .small-note {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>éŸ“æ–‡å–®å­—ç·´ç¿’</h1>
    <div class="small-note">
      å–®å­—æœƒå­˜åœ¨ä½ çš„ Firebase å¸³è™Ÿåº•ä¸‹ï¼Œé›»è…¦å’Œæ‰‹æ©Ÿç™»å…¥åŒä¸€å¸³è™Ÿå°±èƒ½å…±ç”¨ã€‚
    </div>

    <!-- ç™»å…¥å€ -->
    <div class="section" id="authArea">
      <h2>ç™»å…¥</h2>
      <div id="authStatus">å°šæœªç™»å…¥</div>
      <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
      <button id="logoutBtn" class="secondary" style="display:none;">ç™»å‡º</button>
      <div class="small-note">
        å…ˆç™»å…¥ä¹‹å¾Œï¼Œä¸‹é¢çš„å–®å­—åŠŸèƒ½æ‰æœƒå•Ÿç”¨ã€‚
      </div>
    </div>

    <!-- ä¸»åŠŸèƒ½å€ï¼šç™»å…¥å¾Œæ‰é¡¯ç¤º -->
    <div id="appArea" style="display:none;">
      <!-- å€å¡Š 1ï¼šè¼¸å…¥ä»Šå¤©çš„å–®å­— -->
      <div class="section">
        <h2>â‘  è¼¸å…¥ä»Šå¤©çš„æ–°å–®å­—ï¼ˆ10ï½30å€‹ï¼‰</h2>
        <label>ä¸­æ–‡æ„æ€
          <input
            type="text"
            id="chineseInput"
            placeholder="ä¾‹å¦‚ï¼šå­¸æ ¡"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
        </label>
        <label>éŸ“æ–‡
          <input
            type="text"
            id="koreanInput"
            placeholder="ä¾‹å¦‚ï¼ší•™êµ"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
        </label>
        <button id="addWordBtn">åŠ å…¥ä»Šæ—¥å–®å­—</button>
        <button id="cancelEditBtn" class="secondary" style="display:none;">å–æ¶ˆä¿®æ”¹</button>
        <div class="small-note">
          ä¸€å¤©å¯é‡è¤‡åŠ å…¥å¾ˆå¤šæ¬¡ï¼Œå…¨éƒ¨éƒ½ç®—ã€Œä»Šå¤©çš„æ–°å–®å­—ã€ã€‚<br>
          å¦‚æœæ‰“éŒ¯å­—ï¼Œå¯ä»¥åœ¨ä¸‹é¢åˆ—è¡¨æŒ‰ã€Œç·¨è¼¯ã€ä¿®æ”¹ã€‚
        </div>

        <div class="today-list" id="todayList">
          ä»Šå¤©é‚„æ²’æœ‰æ–°å¢å–®å­—ã€‚
        </div>
      </div>

      <!-- å€å¡Š 2ï¼šé¸æ“‡ç·´ç¿’æ¨¡å¼ -->
      <div class="section">
        <h2>â‘¡ é¸æ“‡ç·´ç¿’æ¨¡å¼</h2>
        <label>æ¨¡å¼
          <select id="modeSelect">
            <option value="today">1. ä»Šå¤©çš„æ–°å–®å­—</option>
            <option value="wrong">2. åŠ å¼·ç·´ç¿’ï¼ˆæ›¾ç¶“ç­”éŒ¯çš„å–®å­—ï¼‰</option>
            <option value="all">3. è¤‡ç¿’å…¨éƒ¨å–®å­—</option>
          </select>
        </label>
        <label>é¡Œæ•¸
          <input type="number" id="questionCount" value="30" min="1" max="100">
        </label>
        <button id="startQuizBtn">é–‹å§‹æ¸¬é©—</button>
        <button id="showStrengthBtn" class="secondary" style="margin-left:0;">æŸ¥çœ‹åŠ å¼·ç·´ç¿’å–®å­—</button>
        <button id="showAllWordsBtn" class="secondary">æŸ¥çœ‹å…¨éƒ¨å–®å­—åº«</button>
        <button id="exportAllBtn" class="secondary">åŒ¯å‡ºå…¨éƒ¨å–®å­— CSV</button>
        <button id="exportStrengthBtn" class="secondary">åŒ¯å‡ºåŠ å¼·å–®å­— CSV</button>
        <div class="small-note">å¦‚æœå–®å­—æ•¸ä¸å¤ ï¼Œç³»çµ±æœƒè‡ªå‹•é‡è¤‡å‡ºé¡Œç›´åˆ°é”åˆ°é¡Œæ•¸ã€‚</div>

        <!-- åŠ å¼·ç·´ç¿’å–®å­—åˆ—è¡¨ -->
        <div id="strengthArea" style="display:none; margin-top:8px;">
          <div class="small-note">ç›®å‰åœ¨åŠ å¼·ç·´ç¿’å€çš„å–®å­—ï¼š</div>
          <div id="strengthList" class="today-list">
            ç›®å‰æ²’æœ‰åœ¨åŠ å¼·ç·´ç¿’å€çš„å–®å­—ã€‚
          </div>
        </div>

        <!-- å…¨éƒ¨å–®å­—åº«åˆ—è¡¨ -->
        <div id="allWordsArea" style="display:none; margin-top:8px;">
          <div class="small-note">ç›®å‰æ‰€æœ‰å–®å­—åº«ï¼š</div>
          <label>æœå°‹å–®å­—
            <input
              type="text"
              id="searchInput"
              placeholder="è¼¸å…¥ä¸­æ–‡æˆ–éŸ“æ–‡çš„ä¸€éƒ¨åˆ†"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
          </label>
          <button id="searchBtn">æœå°‹</button>
          <div id="allWordsList" class="today-list">
            ç›®å‰é‚„æ²’æœ‰ä»»ä½•å–®å­—ã€‚
          </div>
        </div>

        <!-- æ¸¬é©—å€ -->
        <div id="quizArea">
          <div id="quizInfo"></div>
          <div id="questionText"></div>
          <label>è«‹è¼¸å…¥éŸ“æ–‡ï¼š
            <input
              type="text"
              id="answerInput"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
          </label>
          <button id="submitAnswerBtn">é€å‡ºç­”æ¡ˆ</button>
          <button id="skipBtn" class="secondary">ä¸æœƒ / è·³é</button>
          <div id="feedback"></div>

          <button id="nextQuestionBtn" style="display:none;" class="secondary">ä¸‹ä¸€é¡Œ</button>

          <div id="summary"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSï¼šFirebase + App é‚è¼¯ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithPopup,
      signOut,
      GoogleAuthProvider
    } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js';

    // â˜…â˜…â˜… æŠŠé€™æ®µæ›æˆã€Œä½ ç¾åœ¨é‚£æ®µå·²ç¶“å¯ä»¥ç™»å…¥çš„ firebaseConfigã€ â˜…â˜…â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyAFWMBI4pTzWYsDLpuUEi3PBJ4u2llDMLc",
      authDomain: "korean-8ab65.firebaseapp.com",
      projectId: "korean-8ab65",
      storageBucket: "korean-8ab65.firebasestorage.app",
      messagingSenderId: "1039991780656",
      appId: "1:1039991780656:web:88c01469fae9f201c844f5",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ---- app state ----
    // word: { id, chinese, korean, date, correctCount, wrongCount, inStrength, strengthStreak }
    let state = { words: [] };

    let quizWords = [];
    let currentIndex = 0;
    let quizStats = { correct: 0, wrong: 0, wrongIds: new Set() };
    let quizActive = false;
    let currentMode = 'today';
    let editingWordId = null;
    let currentUser = null;

    // DOM åƒè€ƒ
    let authStatusEl, appAreaEl, loginBtn, logoutBtn;
    let showStrengthBtn, strengthArea;
    let showAllWordsBtn, allWordsArea;
    let exportAllBtn, exportStrengthBtn;

    function todayString() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    // ===== Firestore è®€å¯« =====
    async function loadState() {
      if (!currentUser) {
        state.words = [];
        return;
      }
      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          const data = snap.data() || {};
          const words = Array.isArray(data.words) ? data.words : [];
          state.words = words.map(w => ({
            id: w.id || (Date.now().toString() + Math.random().toString(36).slice(2)),
            chinese: w.chinese || '',
            korean: w.korean || '',
            date: w.date || todayString(),
            correctCount: w.correctCount || 0,
            wrongCount: w.wrongCount || 0,
            inStrength: !!w.inStrength,
            strengthStreak: w.strengthStreak || 0
          }));
        } else {
          state.words = [];
        }
      } catch (e) {
        console.error('loadState error', e);
        alert('å¾é›²ç«¯è®€å–è³‡æ–™å¤±æ•—ï¼Œå…ˆé¡¯ç¤ºç©ºç™½ï¼Œç­‰ç­‰å¯ä»¥é‡æ–°æ•´ç†å†è©¦ä¸€æ¬¡ã€‚');
        state.words = [];
      }
    }

    function saveState() {
      if (!currentUser) return;
      (async () => {
        try {
          const userDocRef = doc(db, 'users', currentUser.uid);
          await setDoc(userDocRef, { words: state.words }, { merge: true });
        } catch (e) {
          console.error('saveState error', e);
        }
      })();
    }

    // ===== é¡¯ç¤º / éš±è—ä»Šæ—¥å–®å­—ï¼ˆçµ¦ä½œç­”æ™‚ç”¨ï¼‰ =====
    function setTodayListVisible(visible) {
      const todayList = document.getElementById('todayList');
      if (!todayList) return;
      todayList.style.display = visible ? 'block' : 'none';
    }

    // ===== UIï¼šåˆ—è¡¨ =====
    function renderTodayList() {
      const container = document.getElementById('todayList');
      if (!container) return;
      const today = todayString();
      const todays = state.words.filter(w => w.date === today);
      if (!todays.length) {
        container.textContent = 'ä»Šå¤©é‚„æ²’æœ‰æ–°å¢å–®å­—ã€‚';
        return;
      }
      container.innerHTML = todays.map(w => `
        <div class="today-item">
          <span>${w.chinese} â†’ ${w.korean}</span>
          <button class="editWordBtn" data-id="${w.id}">ç·¨è¼¯</button>
        </div>
      `).join('');
      container.querySelectorAll('.editWordBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          startEditWord(btn.dataset.id);
        });
      });
    }

    function renderStrengthList() {
      const container = document.getElementById('strengthList');
      if (!container) return;
      const list = state.words.filter(w => w.inStrength);
      if (!list.length) {
        container.textContent = 'ç›®å‰æ²’æœ‰åœ¨åŠ å¼·ç·´ç¿’å€çš„å–®å­—ã€‚';
        return;
      }
      container.innerHTML = list
        .map(w => `<div>${w.chinese} â†’ ${w.korean}</div>`)
        .join('');
    }

    function renderAllWordsList(filtered = null) {
      const container = document.getElementById('allWordsList');
      if (!container) return;
      const words = filtered || state.words;
      if (!words.length) {
        container.textContent = filtered ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„å–®å­—ã€‚' : 'ç›®å‰é‚„æ²’æœ‰ä»»ä½•å–®å­—ã€‚';
        return;
      }
      container.innerHTML = words.map(w => `
        <div class="today-item">
          <span>[${w.date}] ${w.chinese} â†’ ${w.korean}</span>
          <button class="editWordBtn" data-id="${w.id}">ç·¨è¼¯</button>
        </div>
      `).join('');
      container.querySelectorAll('.editWordBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          startEditWord(btn.dataset.id);
        });
      });
    }

    // æœå°‹å…¨éƒ¨å–®å­—
    function searchAllWords() {
      const input = document.getElementById('searchInput');
      if (!input) return;
      const keyword = input.value.trim();
      if (!keyword) {
        renderAllWordsList(); // æ²’è¼¸å…¥å°±é¡¯ç¤ºå…¨éƒ¨
        return;
      }
      const lower = keyword.toLowerCase();
      const filtered = state.words.filter(w =>
        (w.chinese && w.chinese.includes(keyword)) ||
        (w.korean && w.korean.includes(keyword)) ||
        (w.chinese && w.chinese.toLowerCase().includes(lower)) ||
        (w.korean && w.korean.toLowerCase().includes(lower))
      );
      renderAllWordsList(filtered);
    }

    function startEditWord(id) {
      const word = state.words.find(w => w.id === id);
      if (!word) return;
      const chInput = document.getElementById('chineseInput');
      const krInput = document.getElementById('koreanInput');
      const addBtn = document.getElementById('addWordBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (!chInput || !krInput || !addBtn || !cancelBtn) return;
      chInput.value = word.chinese;
      krInput.value = word.korean;
      addBtn.textContent = 'å„²å­˜ä¿®æ”¹';
      cancelBtn.style.display = 'inline-block';
      editingWordId = id;
    }

    function cancelEdit() {
      const chInput = document.getElementById('chineseInput');
      const krInput = document.getElementById('koreanInput');
      const addBtn = document.getElementById('addWordBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (!chInput || !krInput || !addBtn || !cancelBtn) return;
      editingWordId = null;
      chInput.value = '';
      krInput.value = '';
      addBtn.textContent = 'åŠ å…¥ä»Šæ—¥å–®å­—';
      cancelBtn.style.display = 'none';
    }

    function addWord() {
      const chInput = document.getElementById('chineseInput');
      const krInput = document.getElementById('koreanInput');
      if (!chInput || !krInput) return;
      const ch = chInput.value.trim();
      const kr = krInput.value.trim();
      if (!ch || !kr) {
        alert('ä¸­æ–‡èˆ‡éŸ“æ–‡éƒ½è¦å¡«å–”ï½');
        return;
      }
      if (editingWordId) {
        const word = state.words.find(w => w.id === editingWordId);
        if (word) {
          word.chinese = ch;
          word.korean = kr;
        }
      } else {
        const word = {
          id: Date.now().toString() + Math.random().toString(36).slice(2),
          chinese: ch,
          korean: kr,
          date: todayString(),
          correctCount: 0,
          wrongCount: 0,
          inStrength: false,
          strengthStreak: 0
        };
        state.words.push(word);
      }
      saveState();
      renderTodayList();
      const strengthAreaEl = document.getElementById('strengthArea');
      if (strengthAreaEl && strengthAreaEl.style.display !== 'none') {
        renderStrengthList();
      }
      const allWordsAreaEl = document.getElementById('allWordsArea');
      if (allWordsAreaEl && allWordsAreaEl.style.display !== 'none') {
        renderAllWordsList();
      }
      cancelEdit();
    }

    // ===== åŒ¯å‡º CSV =====
    function exportToCsv(words, filename) {
      if (!words.length) {
        alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
        return;
      }
      const header = [
        'date',
        'chinese',
        'korean',
        'correctCount',
        'wrongCount',
        'inStrength',
        'strengthStreak'
      ];
      const rows = [header];

      for (const w of words) {
        const row = [
          w.date || '',
          w.chinese || '',
          w.korean || '',
          String(w.correctCount || 0),
          String(w.wrongCount || 0),
          w.inStrength ? 'true' : 'false',
          String(w.strengthStreak || 0)
        ];
        rows.push(row);
      }

      // ç°¡å–® CSV escapingï¼šæ¯æ ¼ç”¨é›™å¼•è™ŸåŒ…èµ·ä¾†ï¼Œè£¡é¢çš„é›™å¼•è™Ÿè®Šæˆå…©å€‹
      const csv = rows
        .map(cols =>
          cols
            .map(c => '"' + String(c).replace(/"/g, '""') + '"')
            .join(',')
        )
        .join('\r\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportAllWordsCsv() {
      exportToCsv(state.words, 'all_words.csv');
    }

    function exportStrengthWordsCsv() {
      const words = state.words.filter(w => w.inStrength);
      exportToCsv(words, 'strength_words.csv');
    }

    // ===== å‡ºé¡Œç›¸é—œ =====
    function getCandidateWords(mode) {
      const today = todayString();
      if (mode === 'today') {
        return state.words.filter(w => w.date === today);
      } else if (mode === 'wrong') {
        return state.words.filter(w => w.inStrength);
      } else {
        return state.words;
      }
    }

    function createQuizList(sourceWords, desiredCount) {
      const list = [];
      if (!sourceWords.length) return list;
      desiredCount = Math.max(1, desiredCount);
      while (list.length < desiredCount) {
        for (const w of sourceWords) {
          list.push(w);
          if (list.length >= desiredCount) break;
        }
      }
      for (let i = list.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = list[i];
        list[i] = list[j];
        list[j] = tmp;
      }
      return list;
    }

    function startQuiz() {
      if (!currentUser) {
        alert('è«‹å…ˆç™»å…¥ï½');
        return;
      }
      const modeSelect = document.getElementById('modeSelect');
      const countInput = document.getElementById('questionCount');
      const quizArea = document.getElementById('quizArea');
      const feedback = document.getElementById('feedback');
      const nextBtn = document.getElementById('nextQuestionBtn');
      const summary = document.getElementById('summary');
      if (!modeSelect || !countInput || !quizArea || !feedback || !nextBtn || !summary) return;

      const mode = modeSelect.value;
      currentMode = mode;
      const desired = parseInt(countInput.value, 10) || 30;
      const candidates = getCandidateWords(mode);
      if (!candidates.length) {
        if (mode === 'today') {
          alert('ä»Šå¤©é‚„æ²’æœ‰å–®å­—ï¼Œå¯ä»¥å…ˆåˆ°ä¸Šé¢æ–°å¢å“¦ã€‚');
        } else if (mode === 'wrong') {
          alert('ç›®å‰åŠ å¼·ç·´ç¿’å€æ˜¯ç©ºçš„ï¼Œå…ˆåšå¹¾é¡ŒéŒ¯é¡Œå§ã€‚');
        } else {
          alert('ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œå…ˆæ–°å¢ä¸€äº›å–®å­—å§ï¼');
        }
        return;
      }
      quizWords = createQuizList(candidates, desired);
      currentIndex = 0;
      quizStats = { correct: 0, wrong: 0, wrongIds: new Set() };
      quizActive = true;
      summary.innerHTML = '';
      quizArea.style.display = 'block';
      nextBtn.style.display = 'none';
      feedback.textContent = '';

      // ä½œç­”æ™‚éš±è—ä»Šæ—¥å–®å­—
      setTodayListVisible(false);

      showCurrentQuestion();
    }

    function showCurrentQuestion() {
      if (!quizActive || !quizWords.length) return;
      const info = document.getElementById('quizInfo');
      const qText = document.getElementById('questionText');
      const ansInput = document.getElementById('answerInput');
      const nextBtn = document.getElementById('nextQuestionBtn');
      const feedback = document.getElementById('feedback');
      const submitBtn = document.getElementById('submitAnswerBtn');
      const skipBtn = document.getElementById('skipBtn');
      if (!info || !qText || !ansInput || !nextBtn || !feedback || !submitBtn || !skipBtn) return;

      const total = quizWords.length;
      const idx = currentIndex + 1;
      const word = quizWords[currentIndex];

      info.textContent = `ç¬¬ ${idx} / ${total} é¡Œ`;
      qText.textContent = `ä¸­æ–‡ï¼š${word.chinese}`;
      ansInput.value = '';
      ansInput.disabled = false;
      submitBtn.disabled = false;
      skipBtn.disabled = false;
      nextBtn.style.display = 'none';
      feedback.textContent = '';
      ansInput.focus();
    }

    function normalize(str) { return str.trim(); }

    function handleAnswer(isSkip) {
      if (!quizActive) return;
      const ansInput = document.getElementById('answerInput');
      const feedback = document.getElementById('feedback');
      const submitBtn = document.getElementById('submitAnswerBtn');
      const skipBtn = document.getElementById('skipBtn');
      const nextBtn = document.getElementById('nextQuestionBtn');
      if (!ansInput || !feedback || !submitBtn || !skipBtn || !nextBtn) return;

      const word = quizWords[currentIndex];
      const userAns = normalize(ansInput.value);
      const correctAns = normalize(word.korean);

      let correct = false;
      if (!isSkip && userAns === correctAns) correct = true;

      let extraMsg = '';

      if (correct) {
        quizStats.correct += 1;
        word.correctCount = (word.correctCount || 0) + 1;

        if (word.inStrength) {
          word.strengthStreak = (word.strengthStreak || 0) + 1;
          if (word.strengthStreak >= 3) {
            word.inStrength = false;
            word.strengthStreak = 0;
            extraMsg = 'ï¼ˆå·²é€£çºŒç­”å°ä¸‰æ¬¡ï¼Œå¾åŠ å¼·ç·´ç¿’å€ç•¢æ¥­ ğŸ‰ï¼‰';
          }
        }
        feedback.textContent = 'âœ”ï¸ æ­£ç¢ºï¼' + extraMsg;
      } else {
        quizStats.wrong += 1;
        word.wrongCount = (word.wrongCount || 0) + 1;
        quizStats.wrongIds.add(word.id);

        // éã€ŒåŠ å¼·æ¨¡å¼ã€æ‰æœƒæŠŠéŒ¯é¡ŒåŠ å…¥åŠ å¼·å€
        if (currentMode !== 'wrong' && !word.inStrength) {
          word.inStrength = true;
        }
        word.strengthStreak = 0;

        feedback.textContent = `âŒ ä¸æ­£ç¢ºï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${word.korean}`;
      }

      saveState();
      const strengthAreaEl = document.getElementById('strengthArea');
      if (strengthAreaEl && strengthAreaEl.style.display !== 'none') {
        renderStrengthList();
      }

      ansInput.disabled = true;
      submitBtn.disabled = true;
      skipBtn.disabled = true;
      nextBtn.style.display = 'inline-block';
      nextBtn.textContent = (currentIndex >= quizWords.length - 1) ? 'çœ‹æˆç¸¾' : 'ä¸‹ä¸€é¡Œ';
    }

    function nextQuestion() {
      if (!quizActive) return;
      if (currentIndex >= quizWords.length - 1) {
        endQuiz();
      } else {
        currentIndex += 1;
        showCurrentQuestion();
      }
    }

    function endQuiz() {
      quizActive = false;
      const summary = document.getElementById('summary');
      const ansInput = document.getElementById('answerInput');
      const submitBtn = document.getElementById('submitAnswerBtn');
      const skipBtn = document.getElementById('skipBtn');
      const nextBtn = document.getElementById('nextQuestionBtn');
      if (!summary || !ansInput || !submitBtn || !skipBtn || !nextBtn) return;

      const total = quizWords.length;
      const wrongIdsArr = Array.from(quizStats.wrongIds);
      let wrongListHtml = '';
      if (wrongIdsArr.length) {
        const wrongWords = state.words.filter(w => wrongIdsArr.includes(w.id));
        wrongListHtml = '<ul>' +
          wrongWords.map(w => `<li>${w.chinese} â†’ ${w.korean}</li>`).join('') +
          '</ul>';
      } else {
        wrongListHtml = '<div>å…¨éƒ¨éƒ½ç­”å°ï¼Œå¤ªå¼·å•¦ ğŸ‰</div>';
      }

      const wrongTitle = currentMode === 'wrong'
        ? 'é€™æ¬¡ç­”éŒ¯çš„å–®å­—ï¼š'
        : 'é€™æ¬¡ç­”éŒ¯çš„å–®å­—ï¼ˆè‡ªå‹•åŠ å…¥ã€ŒåŠ å¼·ç·´ç¿’ã€ï¼‰ï¼š';

      summary.innerHTML = `
        <hr>
        <div>æœ¬æ¬¡æˆç¸¾ï¼š${quizStats.correct} é¡Œæ­£ç¢ºï¼Œ${quizStats.wrong} é¡ŒéŒ¯èª¤ï¼ˆå…± ${total} é¡Œï¼‰</div>
        <div style="margin-top:6px;">${wrongTitle}</div>
        ${wrongListHtml}
        <button id="backToModeBtn" class="secondary" style="margin-top:8px;">å›åˆ°æ¨¡å¼é¸æ“‡</button>
      `;

      ansInput.disabled = true;
      submitBtn.disabled = true;
      skipBtn.disabled = true;
      nextBtn.style.display = 'none';

      const backBtn = document.getElementById('backToModeBtn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          const quizArea = document.getElementById('quizArea');
          if (quizArea) quizArea.style.display = 'none';
          // å›åˆ°æ¨¡å¼é¸æ“‡æ™‚ï¼Œé‡æ–°é¡¯ç¤ºä»Šæ—¥å–®å­—
          setTodayListVisible(true);
        }, { once: true });
      }
    }

    // ===== å…¨åŸŸ Enterï¼šé€å‡ºç­”æ¡ˆ / ä¸‹ä¸€é¡Œ =====
    function globalEnterHandler(e) {
      if (e.key !== 'Enter') return;
      const activeEl = document.activeElement;
      // å¦‚æœ focus åœ¨æœå°‹æ¡†ï¼Œå°±è®“å®ƒç•¶æœå°‹ Enterï¼Œä¸è¦æ””æˆªæˆç­”é¡Œ
      if (activeEl && activeEl.id === 'searchInput') {
        e.preventDefault();
        searchAllWords();
        return;
      }

      if (!quizActive) return;
      const quizArea = document.getElementById('quizArea');
      if (!quizArea || quizArea.style.display === 'none') return;
      e.preventDefault();
      const submitBtn = document.getElementById('submitAnswerBtn');
      const nextBtn = document.getElementById('nextQuestionBtn');
      if (submitBtn && !submitBtn.disabled) {
        handleAnswer(false);
      } else if (nextBtn && nextBtn.style.display !== 'none') {
        nextQuestion();
      }
    }

    // ===== DOM è¼‰å…¥å¾Œç¶äº‹ä»¶ & ç›£è½ç™»å…¥ç‹€æ…‹ =====
    window.addEventListener('DOMContentLoaded', () => {
      authStatusEl = document.getElementById('authStatus');
      appAreaEl = document.getElementById('appArea');
      loginBtn = document.getElementById('loginBtn');
      logoutBtn = document.getElementById('logoutBtn');
      showStrengthBtn = document.getElementById('showStrengthBtn');
      strengthArea = document.getElementById('strengthArea');
      showAllWordsBtn = document.getElementById('showAllWordsBtn');
      allWordsArea = document.getElementById('allWordsArea');
      exportAllBtn = document.getElementById('exportAllBtn');
      exportStrengthBtn = document.getElementById('exportStrengthBtn');

      const addWordBtn = document.getElementById('addWordBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const startQuizBtn = document.getElementById('startQuizBtn');
      const submitAnswerBtn = document.getElementById('submitAnswerBtn');
      const skipBtn = document.getElementById('skipBtn');
      const nextQuestionBtn = document.getElementById('nextQuestionBtn');
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');

      if (loginBtn) {
        loginBtn.addEventListener('click', async () => {
          try {
            await signInWithPopup(auth, provider);
          } catch (e) {
            console.error(e);
            alert('ç™»å…¥å¤±æ•—ï¼š' + (e.code || '') + '\n' + (e.message || ''));
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await signOut(auth);
          } catch (e) {
            console.error(e);
            alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
          }
        });
      }

      if (addWordBtn) addWordBtn.addEventListener('click', addWord);
      if (cancelEditBtn) cancelEditBtn.addEventListener('click', cancelEdit);
      if (startQuizBtn) startQuizBtn.addEventListener('click', startQuiz);
      if (submitAnswerBtn) submitAnswerBtn.addEventListener('click', () => handleAnswer(false));
      if (skipBtn) skipBtn.addEventListener('click', () => handleAnswer(true));
      if (nextQuestionBtn) nextQuestionBtn.addEventListener('click', nextQuestion);

      if (showStrengthBtn && strengthArea) {
        showStrengthBtn.addEventListener('click', () => {
          if (strengthArea.style.display === 'none' || strengthArea.style.display === '') {
            renderStrengthList();
            strengthArea.style.display = 'block';
            showStrengthBtn.textContent = 'é—œé–‰åŠ å¼·ç·´ç¿’å–®å­—';
          } else {
            strengthArea.style.display = 'none';
            showStrengthBtn.textContent = 'æŸ¥çœ‹åŠ å¼·ç·´ç¿’å–®å­—';
          }
        });
      }

      if (showAllWordsBtn && allWordsArea) {
        showAllWordsBtn.addEventListener('click', () => {
          if (allWordsArea.style.display === 'none' || allWordsArea.style.display === '') {
            renderAllWordsList();
            allWordsArea.style.display = 'block';
            showAllWordsBtn.textContent = 'é—œé–‰å…¨éƒ¨å–®å­—åº«';
          } else {
            allWordsArea.style.display = 'none';
            showAllWordsBtn.textContent = 'æŸ¥çœ‹å…¨éƒ¨å–®å­—åº«';
          }
        });
      }

      if (exportAllBtn) {
        exportAllBtn.addEventListener('click', exportAllWordsCsv);
      }

      if (exportStrengthBtn) {
        exportStrengthBtn.addEventListener('click', exportStrengthWordsCsv);
      }

      if (searchBtn) {
        searchBtn.addEventListener('click', searchAllWords);
      }
      if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchAllWords();
          }
        });
      }

      document.addEventListener('keydown', globalEnterHandler);

      onAuthStateChanged(auth, async (user) => {
        if (!authStatusEl || !loginBtn || !logoutBtn || !appAreaEl) return;
        if (user) {
          currentUser = user;
          const name = user.displayName || user.email || 'ä½¿ç”¨è€…';
          authStatusEl.textContent = `å·²ç™»å…¥ï¼š${name}`;
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';

          await loadState();
          renderTodayList();
          renderStrengthList();
          appAreaEl.style.display = 'block';
          setTodayListVisible(true);
        } else {
          currentUser = null;
          state.words = [];
          authStatusEl.textContent = 'å°šæœªç™»å…¥';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          appAreaEl.style.display = 'none';
        }
      });

      // åˆå§‹ç•«é¢
      renderTodayList();
      renderStrengthList();
      setTodayListVisible(true);
    });
  </script>
</body>
</html>
